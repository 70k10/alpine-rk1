# Contributor: He Yangxuan <yangxuan8282@gmail.com>
# Contributor: Timo Teras <timo.teras@iki.fi>
# Maintainer: Milan P. StaniÄ‡ <mps@arvanta.net>
pkgname=u-boot
pkgver=2024.01_rc3
pkgrel=1
pkgdesc="u-boot bootloader common files"
url="https://www.denx.de/wiki/U-Boot/"
arch="all !s390x !ppc64le"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
options="!check" # no tests
makedepends="
	bc
	bison
	dtc
	flex
	gcompat
	gnutls-dev
	linux-headers
	openssl-dev
	py3-elftools
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	"
if [ "$CARCH" = "aarch64" ]; then
	makedepends="$makedepends arm-trusted-firmware"
fi
source="https://ftp.denx.de/pub/u-boot/u-boot-${pkgver//_/-}.tar.bz2
	bl31.elf::https://github.com/rockchip-linux/rkbin/raw/b28842d54cade25b5670c450f32146a734fd8aa6/bin/rk35/rk3588_bl31_v1.40.elf
	rk3588_ddr.bin::https://github.com/rockchip-linux/rkbin/raw/b28842d54cade25b5670c450f32146a734fd8aa6/bin/rk35/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_v1.12.bin
	https://github.com/rockchip-linux/rkbin/raw/b28842d54cade25b5670c450f32146a734fd8aa6/tools/ddrbin_tool
	ddrbin_param.txt
	README.txt
	update-u-boot
	fix-tools-build.patch

	0001-board-rockchip-Add-the-Turing-RK1.patch
	"
builddir="$srcdir"/u-boot-${pkgver//_/-}

if [ "$CARCH" = "riscv64" ]; then
	makedepends="$makedepends opensbi"
	export OPENSBI=/usr/share/opensbi/generic/firmware/fw_dynamic.bin
fi

# secfixes:
#   2021.04-r0:
#     - CVE-2021-27097
#     - CVE-2021-27138

case "$CARCH" in
arm*) board_configs="
	beagleboard:am335x_boneblack_vboot
	linksprite:Linksprite_pcDuino3_Nano
	cuboxi:mx6cuboxi
	raspberrypi:rpi_0_w,rpi,rpi_2,rpi_3_32b
	wandboard:wandboard
	qemu:qemu_arm
	odroid:odroid,odroid-xu3
	sunxi:LicheePi_Zero,Bananapi,Lamobo_R1,Cubieboard,Cubieboard2,orangepi_pc
	";;
aarch64) board_configs="
	thunderx:thunderx_88xx
	raspberrypi:rpi_3,rpi_arm64
	odroid:odroid-c2,odroid-n2
	snapdragon:starqltechn
	exynos:a3y17lte,a5y17lte,a7y17lte
	libretech:libretech-cc
	rockchip:rockpro64-rk3399,roc-pc-rk3399,roc-cc-rk3328,pinebook-pro-rk3399
	turing:turing-rk1-rk3588
	qemu:qemu_arm64
	sunxi:pine64-lts,pinebook,orangepi_3,teres_i,a64-olinuxino,a64-olinuxino-emmc,nanopi_neo2,pine64_plus
	";;
riscv64) board_configs="
	qemu:qemu-riscv64,qemu-riscv64_smode
	unleashed:sifive_unleashed
	unmatched:sifive_unmatched
	starfive:starfive_visionfive2
	";;
esac

for board_config in $board_configs; do
	_allboards="$_allboards $pkgname-${board_config%%:*}"
done

subpackages="$_allboards $pkgname-tools"
case "$CARCH" in
	arm*|aarch64|riscv64) subpackages="$pkgname-all:_all $_allboards $pkgname-tools";;
esac

build() {
	# Set UART parameters for RK1
	cp "$srcdir"/ddrbin_tool "$srcdir"/rk3588_ddr.bin .
	chmod +x ddrbin_tool
	./ddrbin_tool "$srcdir"/ddrbin_param.txt rk3588_ddr.bin

	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	local board_config board
	for board_config in $board_configs; do
		local configs="${board_config#*:}"
		for board in ${configs//,/ }; do
			msg "Building u-boot for $board"

			case "$board" in
				"pine64-lts"|"pinebook"|"teres_i"|"a64-olinuxino"|"a64-olinuxino-emmc"|"pine64_plus")
					export BL31="/usr/share/arm-trusted-firmware/sun50i_a64/bl31.bin"
					export SCP=/dev/null;;
				"orangepi_3")
					export BL31="/usr/share/arm-trusted-firmware/sun50i_h6/bl31.bin";;
				"pinebook-pro-rk3399"|"rockpro64-rk3399"|"roc-pc-rk3399")
					export BL31="/usr/share/arm-trusted-firmware/rk3399/bl31.elf";;
				"roc-cc-rk3328")
					export BL31="/usr/share/arm-trusted-firmware/rk3328/bl31.elf";;
				"turing-rk1-rk3588")
					export ROCKCHIP_TPL="$PWD/rk3588_ddr.bin"
					export BL31="$srcdir/bl31.elf";;
			esac

			export BUILD_DIR="$builddir"/build/$board
			mkdir -p "$BUILD_DIR"
			make O="$BUILD_DIR" ${board}_config
			make O="$BUILD_DIR" all
		done
	done
	msg "Building u-boot-tools"
	make tools-only_defconfig
	make tools-all
}

package() {
	case "$CARCH" in
		mips64|x86*) return;;
	esac
	cd "$builddir"/build
	mkdir -p "$pkgdir"/usr/share/$pkgname "$pkgdir"/usr/sbin
	install "$srcdir"/README.txt "$pkgdir"/usr/share/$pkgname/README.txt
	install "$srcdir"/update-u-boot "$pkgdir"/usr/sbin
}

tools() {
	pkgdesc="u-boot bootloader utility tools"
	provides="uboot-tools"
	replaces="uboot-tools"
	mkdir -p $pkgdir
	mkdir $subpkgdir
	cd "$builddir"
	for tool in dumpimage env/fw_printenv \
		fit_check_sign fit_info gdb/gdbcont gdb/gdbsend gen_eth_addr img2srec \
		mkenvimage mkimage ncb proftool; do
		install -D tools/$tool \
		$subpkgdir/usr/bin/"$(basename $tool)"
		done
	install -Dm644 tools/env/fw_env.config \
		"$subpkgdir/usr/share/doc/$pkgname/examples/fw_env.config"
	cd "$subpkgdir"/usr/bin
	ln -sf fw_printenv fw_setenv
}

_all() {
	pkgdesc="u-boot for all boards (meta package)"
	depends="$_allboards"

	mkdir -p "$subpkgdir"/
}

_split_boards() {
	cd "$builddir"/build
	pkgdesc="u-boot for $1"
	depends="u-boot"
	shift
	local board
	for board; do
		msg "Including board $board"
		mkdir -p "$subpkgdir"/usr/share/$pkgname/$board
		export BUILD_DIR="$builddir"/build/$board

		local board_images=""
		case "$board" in
			"sifive_unleashed") board_images="u-boot.itb spl/u-boot-spl.bin --" ;;
			"sifive_unmatched") board_images="u-boot.itb spl/u-boot-spl.bin --" ;;
			"starfive_visionfive2") board_images="u-boot.itb spl/u-boot-spl.bin.normal.out --" ;;
			"pinebook-pro-rk3399"|"rockpro64-rk3399"|"roc-pc-rk3399"|"roc-cc-rk3328") board_images="u-boot-rockchip.bin --" ;;
			"turing-rk1-rk3588") board_images="u-boot.itb idbloader.img --";;
		esac

		local ok=no
		for image in $board_images u-boot-sunxi-with-spl.bin -- MLO SPL u-boot.img -- u-boot.bin; do
			if [ "$image" = "--" ]; then
				[ "$ok" = yes ] && break
				continue
			fi
			if [ -e "$BUILD_DIR"/$image ]; then
				cp "$BUILD_DIR"/$image "$subpkgdir"/usr/share/$pkgname/$board
				ok=yes
			fi
		done
		[ "$ok" = yes ] || return
	done
}

for board_config in $board_configs; do
	_board="${board_config%%:*}"
	_configs="${board_config#*:}"
	eval "$_board() { _split_boards $_board ${_configs//,/ }; }"
done

sha512sums="
51a45e6a0008ef04570b6357518c85fd22604be0090ad5bf1dc7c821eb34ea33441314c49128dd0bd3084406b7138497044bb47f7e57d38a680768fb9f2f6577  u-boot-2024.01-rc3.tar.bz2
f8c9bb6e84d6f0620c976ac7ad5dd7ec7ff9dfdd4b1d03d2bf6653e7beccf80bdf2debfc92fb1f696dba92fb40287d3c45897e0078951451d0835cb61a5f16d1  README.txt
6cf882785fa12abcfdfa82119f6a3446229bc75f4c19d5751676625dda81df5ca428c2b631187ecbc39261b081b1a8b53bceeac9f43a3229f7610abc4d9862a2  update-u-boot
83fc42c698f8236ba1f7d71383863e0bda255ada85bb885856a24b2036944d230d918a9d965d5ff90720726c9ee85ffda5e88eefc27b94ef9e7b4f456dcfb195  fix-tools-build.patch
5656e0713c92f1781dd0d417392ad20e7f94e3b0ba92486a1c13b19e0f9d30ee6c7ae339514bf84d3be10ceed59fe2c86e9a8a56c8e20d6ab6a0a53f5e5e48b2  bl31.elf
f71a2c4489495721f846e7dc07c3d996c412b5113fc03bcc70a38e0d23653c3215d07e85c9f7a0e55318d7bd625eb12476b7aead9cdaacdb888d96cbaa2f3191  rk3588_ddr.bin
8d76a1adc152c356d10948b4219a904f3ea4a4d1c4ab0ebe6d924be0f0e2a342c1616a405d93d8c001e7ff4bcf9bb76363ed60a4a9cf5dac05ad2856339dafc2  ddrbin_tool
067dea217de57ff4a5d975e46e94fc12d7edc5f353310e2ed61d70281860a82d35dcffa8be3628bec8bc3c2f26a574882ee6286ebb4753b83c88f5c851d665dc  ddrbin_param.txt
d9f194a6b5b8ba788e56e5b1cbf663f3feea417b0751ccc93796d518c0dd886ccf9171e78845d35a68afa38a668a33404dcac36d571486112e2af60e579e9623  0001-board-rockchip-Add-the-Turing-RK1.patch
"
